{% extends "base.html" %}

{% block title %}Shop - E-Commerce Store{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Filters Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-filter me-2"></i>Filters
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" placeholder="Search items...">
                        </div>
                        <div class="col-md-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="min-price" class="form-label">Min Price</label>
                            <input type="number" class="form-control" id="min-price" placeholder="0" min="0" step="0.01">
                        </div>
                        <div class="col-md-2">
                            <label for="max-price" class="form-label">Max Price</label>
                            <input type="number" class="form-control" id="max-price" placeholder="1000" min="0" step="0.01">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-search me-2"></i>Apply
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Items Grid -->
    <div class="row" id="items-container">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allItems = [];

// Load items on page load
document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadItems();
    
    // Add event listeners for real-time search
    document.getElementById('search').addEventListener('input', debounce(applyFilters, 300));
});

async function loadCategories() {
    try {
        const response = await fetch('/api/categories');
        const categories = await response.json();
        
        const categorySelect = document.getElementById('category');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

async function loadItems() {
    try {
        const response = await fetch('/api/items');
        allItems = await response.json();
        displayItems(allItems);
    } catch (error) {
        console.error('Error loading items:', error);
        showToast('Failed to load items', 'error');
    }
}

function displayItems(items) {
    const container = document.getElementById('items-container');
    
    if (items.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-search display-4 text-muted"></i>
                <h3 class="mt-3 text-muted">No items found</h3>
                <p class="text-muted">Try adjusting your filters</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = items.map(item => `
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card h-100 item-card">
                <div class="card-img-placeholder">
                    <i class="fas fa-box display-4 text-muted"></i>
                </div>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${item.name}</h5>
                    <p class="card-text text-muted small">${item.description}</p>
                    <div class="mt-auto">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 text-primary mb-0">$${item.price.toFixed(2)}</span>
                            <small class="text-muted">${item.category}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-boxes me-1"></i>
                                ${item.stock} in stock
                            </small>
                            <button class="btn btn-primary btn-sm" 
                                    onclick="addToCart(${item.id})" 
                                    ${item.stock === 0 ? 'disabled' : ''}>
                                <i class="fas fa-cart-plus me-1"></i>
                                ${item.stock === 0 ? 'Out of Stock' : 'Add to Cart'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function applyFilters() {
    const search = document.getElementById('search').value.toLowerCase();
    const category = document.getElementById('category').value;
    const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
    const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
    
    const filteredItems = allItems.filter(item => {
        const matchesSearch = !search || 
            item.name.toLowerCase().includes(search) || 
            item.description.toLowerCase().includes(search);
        const matchesCategory = !category || item.category === category;
        const matchesPrice = item.price >= minPrice && item.price <= maxPrice;
        
        return matchesSearch && matchesCategory && matchesPrice;
    });
    
    displayItems(filteredItems);
}

async function addToCart(itemId) {
    if (!isLoggedIn()) {
        // Add to local storage for anonymous users
        addToLocalCart(itemId, 1);
        showToast('Item added to cart!', 'success');
        return;
    }
    
    try {
        const response = await fetch('/api/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify({ item_id: itemId, quantity: 1 })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Item added to cart!', 'success');
            updateCartCount();
        } else {
            showToast(result.error || 'Failed to add item to cart', 'error');
        }
    } catch (error) {
        console.error('Error adding to cart:', error);
        showToast('Network error occurred', 'error');
    }
}

// Debounce function for search input
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}
